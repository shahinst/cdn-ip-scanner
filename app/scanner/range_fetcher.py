"""
CDN IP Scanner V2.0 - Range Fetcher (Linux Edition)
Author: shahinst

Fetches CDN IP ranges from multiple sources with:
  - Automatic retry (3 attempts)
  - DNS resolution fallback
  - SSL certificate verification fallback
  - Timeout handling for slow server connections
"""

import time
import ipaddress
import logging
import requests
import urllib3

urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

logger = logging.getLogger(__name__)

FETCH_TIMEOUT = 30
FETCH_RETRIES = 3
FETCH_HEADERS = {
    'User-Agent': 'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
    'Accept': 'application/json, text/plain, */*',
    'Accept-Language': 'en-US,en;q=0.9',
    'Connection': 'keep-alive',
}


def _robust_get(url, timeout=FETCH_TIMEOUT, verify=True, retries=FETCH_RETRIES):
    """
    HTTP GET with automatic retry, SSL fallback, and error logging.
    On SSL error, retries with verify=False.
    """
    last_err = None
    for attempt in range(1, retries + 1):
        try:
            r = requests.get(
                url,
                timeout=timeout,
                headers=FETCH_HEADERS,
                verify=verify,
            )
            r.raise_for_status()
            return r
        except requests.exceptions.SSLError as e:
            logger.warning("SSL error on %s (attempt %d): %s", url, attempt, e)
            if verify:
                verify = False
                continue
            last_err = e
        except requests.exceptions.ConnectionError as e:
            logger.warning("Connection error on %s (attempt %d): %s", url, attempt, e)
            last_err = e
            if attempt < retries:
                time.sleep(1.5 * attempt)
        except requests.exceptions.Timeout as e:
            logger.warning("Timeout on %s (attempt %d): %s", url, attempt, e)
            last_err = e
            if attempt < retries:
                time.sleep(1.0)
        except requests.exceptions.RequestException as e:
            logger.warning("Request error on %s (attempt %d): %s", url, attempt, e)
            last_err = e
            if attempt < retries:
                time.sleep(1.0)
    raise requests.exceptions.ConnectionError(
        f"Failed after {retries} attempts: {url} — {last_err}"
    )


class BuiltinCDNRanges:
    """
    مجموعه رنج‌های CDN به صورت built-in داخل برنامه.
    شامل رنج‌های /24 شناخته‌شده Cloudflare و سایر CDN های معتبر.
    بدون نیاز به هیچ منبع خارجی.
    """

    # رنج‌های اصلی Cloudflare (CIDR رسمی)
    _CLOUDFLARE_CORE = [
        '103.21.244.0/22',
        '103.22.200.0/22',
        '103.31.4.0/22',
        '104.16.0.0/13',
        '104.24.0.0/14',
        '108.162.192.0/18',
        '131.0.72.0/22',
        '141.101.64.0/18',
        '162.159.0.0/15',
        '172.64.0.0/13',
        '173.245.48.0/20',
        '188.114.96.0/20',
        '190.93.240.0/20',
        '197.234.240.0/22',
        '198.41.128.0/17',
    ]

    # رنج‌های /24 دقیق Cloudflare (پوشش بیشتر)
    _CLOUDFLARE_24 = [
        # 104.16.x.x
        '104.16.0.0/24', '104.16.1.0/24', '104.16.2.0/24', '104.16.3.0/24',
        '104.16.4.0/24', '104.16.5.0/24', '104.16.6.0/24', '104.16.7.0/24',
        '104.16.8.0/24', '104.16.9.0/24', '104.16.10.0/24', '104.16.11.0/24',
        '104.16.12.0/24', '104.16.13.0/24', '104.16.14.0/24', '104.16.15.0/24',
        '104.16.16.0/24', '104.16.17.0/24', '104.16.18.0/24', '104.16.19.0/24',
        '104.16.20.0/24', '104.16.21.0/24', '104.16.22.0/24', '104.16.23.0/24',
        '104.16.24.0/24', '104.16.25.0/24', '104.16.26.0/24', '104.16.27.0/24',
        '104.16.28.0/24', '104.16.29.0/24', '104.16.30.0/24', '104.16.31.0/24',
        '104.16.32.0/24', '104.16.33.0/24', '104.16.34.0/24', '104.16.35.0/24',
        '104.16.36.0/24', '104.16.37.0/24', '104.16.38.0/24', '104.16.39.0/24',
        '104.16.40.0/24', '104.16.41.0/24', '104.16.42.0/24', '104.16.43.0/24',
        '104.16.44.0/24', '104.16.45.0/24', '104.16.46.0/24', '104.16.47.0/24',
        '104.16.48.0/24', '104.16.49.0/24', '104.16.50.0/24', '104.16.51.0/24',
        '104.16.52.0/24', '104.16.53.0/24', '104.16.54.0/24', '104.16.55.0/24',
        '104.16.56.0/24', '104.16.57.0/24', '104.16.58.0/24', '104.16.59.0/24',
        '104.16.60.0/24', '104.16.61.0/24', '104.16.62.0/24', '104.16.63.0/24',
        # 104.17.x.x
        '104.17.0.0/24', '104.17.1.0/24', '104.17.2.0/24', '104.17.3.0/24',
        '104.17.4.0/24', '104.17.5.0/24', '104.17.6.0/24', '104.17.7.0/24',
        '104.17.8.0/24', '104.17.9.0/24', '104.17.10.0/24', '104.17.11.0/24',
        '104.17.12.0/24', '104.17.13.0/24', '104.17.14.0/24', '104.17.15.0/24',
        '104.17.16.0/24', '104.17.17.0/24', '104.17.18.0/24', '104.17.19.0/24',
        '104.17.20.0/24', '104.17.21.0/24', '104.17.22.0/24', '104.17.23.0/24',
        '104.17.24.0/24', '104.17.25.0/24', '104.17.26.0/24', '104.17.27.0/24',
        '104.17.28.0/24', '104.17.29.0/24', '104.17.30.0/24', '104.17.31.0/24',
        # 104.18.x.x
        '104.18.0.0/24', '104.18.1.0/24', '104.18.2.0/24', '104.18.3.0/24',
        '104.18.4.0/24', '104.18.5.0/24', '104.18.6.0/24', '104.18.7.0/24',
        '104.18.8.0/24', '104.18.9.0/24', '104.18.10.0/24', '104.18.11.0/24',
        '104.18.12.0/24', '104.18.13.0/24', '104.18.14.0/24', '104.18.15.0/24',
        '104.18.16.0/24', '104.18.17.0/24', '104.18.18.0/24', '104.18.19.0/24',
        '104.18.20.0/24', '104.18.21.0/24', '104.18.22.0/24', '104.18.23.0/24',
        '104.18.24.0/24', '104.18.25.0/24', '104.18.26.0/24', '104.18.27.0/24',
        '104.18.28.0/24', '104.18.29.0/24', '104.18.30.0/24', '104.18.31.0/24',
        # 104.19.x.x
        '104.19.0.0/24', '104.19.1.0/24', '104.19.2.0/24', '104.19.3.0/24',
        '104.19.4.0/24', '104.19.5.0/24', '104.19.6.0/24', '104.19.7.0/24',
        '104.19.8.0/24', '104.19.9.0/24', '104.19.10.0/24', '104.19.11.0/24',
        '104.19.12.0/24', '104.19.13.0/24', '104.19.14.0/24', '104.19.15.0/24',
        # 104.20.x.x
        '104.20.0.0/24', '104.20.1.0/24', '104.20.2.0/24', '104.20.3.0/24',
        '104.20.4.0/24', '104.20.5.0/24', '104.20.6.0/24', '104.20.7.0/24',
        '104.20.8.0/24', '104.20.9.0/24', '104.20.10.0/24', '104.20.11.0/24',
        '104.20.12.0/24', '104.20.13.0/24', '104.20.14.0/24', '104.20.15.0/24',
        # 104.21.x.x
        '104.21.0.0/24', '104.21.1.0/24', '104.21.2.0/24', '104.21.3.0/24',
        '104.21.4.0/24', '104.21.5.0/24', '104.21.6.0/24', '104.21.7.0/24',
        '104.21.8.0/24', '104.21.9.0/24', '104.21.10.0/24', '104.21.11.0/24',
        '104.21.12.0/24', '104.21.13.0/24', '104.21.14.0/24', '104.21.15.0/24',
        '104.21.16.0/24', '104.21.17.0/24', '104.21.18.0/24', '104.21.19.0/24',
        '104.21.20.0/24', '104.21.21.0/24', '104.21.22.0/24', '104.21.23.0/24',
        '104.21.24.0/24', '104.21.25.0/24', '104.21.26.0/24', '104.21.27.0/24',
        '104.21.28.0/24', '104.21.29.0/24', '104.21.30.0/24', '104.21.31.0/24',
        # 162.159.x.x
        '162.159.0.0/24', '162.159.1.0/24', '162.159.2.0/24', '162.159.3.0/24',
        '162.159.4.0/24', '162.159.5.0/24', '162.159.6.0/24', '162.159.7.0/24',
        '162.159.8.0/24', '162.159.9.0/24', '162.159.10.0/24', '162.159.11.0/24',
        '162.159.12.0/24', '162.159.13.0/24', '162.159.14.0/24', '162.159.15.0/24',
        '162.159.16.0/24', '162.159.17.0/24', '162.159.18.0/24', '162.159.19.0/24',
        '162.159.20.0/24', '162.159.21.0/24', '162.159.22.0/24', '162.159.23.0/24',
        '162.159.24.0/24', '162.159.25.0/24', '162.159.26.0/24', '162.159.27.0/24',
        '162.159.28.0/24', '162.159.29.0/24', '162.159.30.0/24', '162.159.31.0/24',
        '162.159.128.0/24', '162.159.129.0/24', '162.159.130.0/24', '162.159.131.0/24',
        '162.159.132.0/24', '162.159.133.0/24', '162.159.134.0/24', '162.159.135.0/24',
        '162.159.136.0/24', '162.159.137.0/24', '162.159.138.0/24', '162.159.139.0/24',
        '162.159.140.0/24', '162.159.141.0/24', '162.159.142.0/24', '162.159.143.0/24',
        '162.159.144.0/24', '162.159.145.0/24', '162.159.146.0/24', '162.159.147.0/24',
        '162.159.148.0/24', '162.159.149.0/24', '162.159.150.0/24', '162.159.151.0/24',
        '162.159.152.0/24', '162.159.153.0/24', '162.159.154.0/24', '162.159.155.0/24',
        '162.159.156.0/24', '162.159.157.0/24', '162.159.158.0/24', '162.159.159.0/24',
        '162.159.160.0/24', '162.159.192.0/24', '162.159.200.0/24', '162.159.204.0/24',
        '162.159.208.0/24', '162.159.240.0/24', '162.159.241.0/24',
        # 172.64.x.x - 172.71.x.x
        '172.64.0.0/24', '172.64.1.0/24', '172.64.2.0/24', '172.64.3.0/24',
        '172.64.4.0/24', '172.64.5.0/24', '172.64.6.0/24', '172.64.7.0/24',
        '172.64.8.0/24', '172.64.9.0/24', '172.64.10.0/24', '172.64.11.0/24',
        '172.64.32.0/24', '172.64.33.0/24', '172.64.34.0/24', '172.64.35.0/24',
        '172.64.36.0/24', '172.64.37.0/24', '172.64.38.0/24', '172.64.39.0/24',
        '172.64.40.0/24', '172.64.41.0/24', '172.64.128.0/24', '172.64.129.0/24',
        '172.64.130.0/24', '172.64.131.0/24', '172.64.132.0/24', '172.64.133.0/24',
        '172.64.134.0/24', '172.64.135.0/24', '172.64.136.0/24', '172.64.137.0/24',
        '172.64.138.0/24', '172.64.139.0/24', '172.64.140.0/24', '172.64.141.0/24',
        '172.64.142.0/24', '172.64.143.0/24', '172.64.144.0/24', '172.64.145.0/24',
        '172.64.146.0/24', '172.64.147.0/24', '172.64.148.0/24', '172.64.149.0/24',
        '172.64.150.0/24', '172.64.151.0/24', '172.64.152.0/24', '172.64.153.0/24',
        '172.64.154.0/24', '172.64.155.0/24', '172.64.156.0/24', '172.64.157.0/24',
        '172.64.158.0/24', '172.64.159.0/24',
        '172.65.0.0/24', '172.65.1.0/24', '172.65.2.0/24', '172.65.3.0/24',
        '172.65.4.0/24', '172.65.5.0/24', '172.65.8.0/24', '172.65.16.0/24',
        '172.65.32.0/24', '172.65.48.0/24', '172.65.64.0/24', '172.65.80.0/24',
        '172.65.96.0/24', '172.65.112.0/24', '172.65.128.0/24', '172.65.144.0/24',
        '172.65.160.0/24', '172.65.176.0/24', '172.65.192.0/24', '172.65.208.0/24',
        '172.65.224.0/24', '172.65.240.0/24',
        '172.66.0.0/24', '172.66.1.0/24', '172.66.2.0/24', '172.66.3.0/24',
        '172.66.40.0/24', '172.66.41.0/24', '172.66.42.0/24', '172.66.43.0/24',
        '172.66.44.0/24', '172.66.45.0/24', '172.66.46.0/24', '172.66.47.0/24',
        '172.67.0.0/24', '172.67.1.0/24', '172.67.2.0/24', '172.67.3.0/24',
        '172.67.4.0/24', '172.67.5.0/24', '172.67.6.0/24', '172.67.7.0/24',
        '172.67.8.0/24', '172.67.9.0/24', '172.67.10.0/24', '172.67.11.0/24',
        '172.67.12.0/24', '172.67.13.0/24', '172.67.14.0/24', '172.67.15.0/24',
        '172.67.16.0/24', '172.67.17.0/24', '172.67.18.0/24', '172.67.19.0/24',
        '172.67.20.0/24', '172.67.21.0/24', '172.67.22.0/24', '172.67.23.0/24',
        '172.67.24.0/24', '172.67.25.0/24', '172.67.26.0/24', '172.67.27.0/24',
        '172.67.28.0/24', '172.67.29.0/24', '172.67.30.0/24', '172.67.31.0/24',
        '172.67.32.0/24', '172.67.33.0/24', '172.67.34.0/24', '172.67.35.0/24',
        '172.67.64.0/24', '172.67.65.0/24', '172.67.66.0/24', '172.67.67.0/24',
        '172.67.128.0/24', '172.67.129.0/24', '172.67.130.0/24', '172.67.131.0/24',
        '172.67.132.0/24', '172.67.133.0/24', '172.67.134.0/24', '172.67.135.0/24',
        '172.67.136.0/24', '172.67.137.0/24', '172.67.138.0/24', '172.67.139.0/24',
        '172.67.140.0/24', '172.67.141.0/24', '172.67.142.0/24', '172.67.143.0/24',
        '172.67.144.0/24', '172.67.145.0/24', '172.67.146.0/24', '172.67.147.0/24',
        '172.67.148.0/24', '172.67.149.0/24', '172.67.150.0/24', '172.67.151.0/24',
        '172.67.152.0/24', '172.67.153.0/24', '172.67.154.0/24', '172.67.155.0/24',
        '172.67.156.0/24', '172.67.157.0/24', '172.67.158.0/24', '172.67.159.0/24',
        '172.67.160.0/24', '172.67.161.0/24', '172.67.162.0/24', '172.67.163.0/24',
        '172.67.192.0/24', '172.67.193.0/24', '172.67.194.0/24', '172.67.195.0/24',
        '172.67.196.0/24', '172.67.197.0/24', '172.67.198.0/24', '172.67.199.0/24',
        '172.67.200.0/24', '172.67.201.0/24', '172.67.202.0/24', '172.67.203.0/24',
        '172.67.204.0/24', '172.67.205.0/24', '172.67.206.0/24', '172.67.207.0/24',
        '172.67.208.0/24', '172.67.209.0/24', '172.67.210.0/24', '172.67.211.0/24',
        '172.67.212.0/24', '172.67.213.0/24', '172.67.214.0/24', '172.67.215.0/24',
        '172.67.216.0/24', '172.67.217.0/24', '172.67.218.0/24', '172.67.219.0/24',
        '172.67.220.0/24', '172.67.221.0/24', '172.67.222.0/24', '172.67.223.0/24',
        '172.67.224.0/24', '172.67.225.0/24', '172.67.226.0/24', '172.67.227.0/24',
        '172.67.228.0/24', '172.67.229.0/24', '172.67.230.0/24', '172.67.231.0/24',
        '172.67.232.0/24', '172.67.233.0/24', '172.67.234.0/24', '172.67.235.0/24',
        '172.67.236.0/24', '172.67.237.0/24', '172.67.238.0/24', '172.67.239.0/24',
        '172.67.240.0/24', '172.67.241.0/24', '172.67.242.0/24', '172.67.243.0/24',
        '172.67.244.0/24', '172.67.245.0/24', '172.67.246.0/24', '172.67.247.0/24',
        '172.67.248.0/24', '172.67.249.0/24', '172.67.250.0/24', '172.67.251.0/24',
        '172.67.252.0/24', '172.67.253.0/24', '172.67.254.0/24', '172.67.255.0/24',
        # 173.245.48.x
        '173.245.48.0/24', '173.245.49.0/24', '173.245.50.0/24', '173.245.51.0/24',
        '173.245.52.0/24', '173.245.53.0/24', '173.245.54.0/24', '173.245.55.0/24',
        '173.245.56.0/24', '173.245.57.0/24', '173.245.58.0/24', '173.245.59.0/24',
        '173.245.60.0/24', '173.245.61.0/24', '173.245.62.0/24', '173.245.63.0/24',
        # 188.114.96.x
        '188.114.96.0/24', '188.114.97.0/24', '188.114.98.0/24', '188.114.99.0/24',
        '188.114.100.0/24', '188.114.101.0/24', '188.114.102.0/24', '188.114.103.0/24',
        '188.114.104.0/24', '188.114.105.0/24', '188.114.106.0/24', '188.114.107.0/24',
        '188.114.108.0/24', '188.114.109.0/24', '188.114.110.0/24', '188.114.111.0/24',
        # 190.93.240.x
        '190.93.240.0/24', '190.93.241.0/24', '190.93.242.0/24', '190.93.243.0/24',
        '190.93.244.0/24', '190.93.245.0/24', '190.93.246.0/24', '190.93.247.0/24',
        '190.93.248.0/24', '190.93.249.0/24', '190.93.250.0/24', '190.93.251.0/24',
        '190.93.252.0/24', '190.93.253.0/24', '190.93.254.0/24', '190.93.255.0/24',
        # 197.234.240.x
        '197.234.240.0/24', '197.234.241.0/24', '197.234.242.0/24', '197.234.243.0/24',
        # 198.41.128.x
        '198.41.128.0/24', '198.41.129.0/24', '198.41.130.0/24', '198.41.131.0/24',
        '198.41.132.0/24', '198.41.133.0/24', '198.41.134.0/24', '198.41.135.0/24',
        '198.41.136.0/24', '198.41.137.0/24', '198.41.138.0/24', '198.41.139.0/24',
        '198.41.140.0/24', '198.41.141.0/24', '198.41.142.0/24', '198.41.143.0/24',
        '198.41.144.0/24', '198.41.145.0/24', '198.41.146.0/24', '198.41.147.0/24',
        '198.41.148.0/24', '198.41.149.0/24', '198.41.150.0/24', '198.41.151.0/24',
        '198.41.192.0/24', '198.41.193.0/24', '198.41.194.0/24', '198.41.195.0/24',
        '198.41.196.0/24', '198.41.197.0/24', '198.41.198.0/24', '198.41.199.0/24',
        '198.41.200.0/24', '198.41.201.0/24', '198.41.202.0/24', '198.41.203.0/24',
        '198.41.204.0/24', '198.41.205.0/24', '198.41.206.0/24', '198.41.207.0/24',
        '198.41.208.0/24', '198.41.209.0/24', '198.41.210.0/24', '198.41.211.0/24',
        '198.41.212.0/24', '198.41.213.0/24', '198.41.214.0/24', '198.41.215.0/24',
        '198.41.216.0/24', '198.41.217.0/24', '198.41.218.0/24', '198.41.219.0/24',
        '198.41.220.0/24', '198.41.221.0/24', '198.41.222.0/24', '198.41.223.0/24',
        '198.41.224.0/24', '198.41.225.0/24', '198.41.226.0/24', '198.41.227.0/24',
        '198.41.228.0/24', '198.41.229.0/24', '198.41.230.0/24', '198.41.231.0/24',
        '198.41.232.0/24', '198.41.233.0/24', '198.41.234.0/24', '198.41.235.0/24',
        '198.41.236.0/24', '198.41.237.0/24', '198.41.238.0/24', '198.41.239.0/24',
        '198.41.240.0/24', '198.41.241.0/24', '198.41.242.0/24', '198.41.243.0/24',
        '198.41.244.0/24', '198.41.245.0/24', '198.41.246.0/24', '198.41.247.0/24',
        '198.41.248.0/24', '198.41.249.0/24', '198.41.250.0/24', '198.41.251.0/24',
        '198.41.252.0/24', '198.41.253.0/24', '198.41.254.0/24', '198.41.255.0/24',
        # 141.101.64.x - 141.101.127.x
        '141.101.64.0/24', '141.101.65.0/24', '141.101.66.0/24', '141.101.67.0/24',
        '141.101.68.0/24', '141.101.69.0/24', '141.101.70.0/24', '141.101.71.0/24',
        '141.101.72.0/24', '141.101.73.0/24', '141.101.74.0/24', '141.101.75.0/24',
        '141.101.76.0/24', '141.101.77.0/24', '141.101.78.0/24', '141.101.79.0/24',
        '141.101.80.0/24', '141.101.81.0/24', '141.101.82.0/24', '141.101.83.0/24',
        '141.101.84.0/24', '141.101.85.0/24', '141.101.86.0/24', '141.101.87.0/24',
        '141.101.88.0/24', '141.101.89.0/24', '141.101.90.0/24', '141.101.91.0/24',
        '141.101.92.0/24', '141.101.93.0/24', '141.101.94.0/24', '141.101.95.0/24',
        '141.101.96.0/24', '141.101.97.0/24', '141.101.98.0/24', '141.101.99.0/24',
        '141.101.100.0/24', '141.101.101.0/24', '141.101.102.0/24', '141.101.103.0/24',
        '141.101.104.0/24', '141.101.105.0/24', '141.101.106.0/24', '141.101.107.0/24',
        '141.101.108.0/24', '141.101.109.0/24', '141.101.110.0/24', '141.101.111.0/24',
        '141.101.112.0/24', '141.101.113.0/24', '141.101.114.0/24', '141.101.115.0/24',
        '141.101.116.0/24', '141.101.117.0/24', '141.101.118.0/24', '141.101.119.0/24',
        '141.101.120.0/24', '141.101.121.0/24', '141.101.122.0/24', '141.101.123.0/24',
        '141.101.124.0/24', '141.101.125.0/24', '141.101.126.0/24', '141.101.127.0/24',
    ]

    @classmethod
    def get_ranges(cls):
        """
        برگرداندن تمام رنج‌های CDN built-in.
        ترکیبی از CIDR های اصلی و رنج‌های /24 دقیق.
        """
        all_ranges = list(cls._CLOUDFLARE_CORE) + list(cls._CLOUDFLARE_24)
        return list(set(all_ranges))

    @classmethod
    def get_core_ranges(cls):
        """فقط رنج‌های CIDR اصلی Cloudflare."""
        return list(cls._CLOUDFLARE_CORE)

    @classmethod
    def get_detailed_ranges(cls):
        """فقط رنج‌های /24 دقیق."""
        return list(cls._CLOUDFLARE_24)


class RangeFetcher:

    @staticmethod
    def get_cloudflare_official():
        try:
            r = _robust_get('https://api.cloudflare.com/client/v4/ips')
            data = r.json()
            return data.get('result', {}).get('ipv4_cidrs', [])
        except Exception as e:
            logger.error("Cloudflare official fetch failed: %s", e)
            return []

    @staticmethod
    def get_cloudflare_asn():
        return [
            '104.16.0.0/12', '172.64.0.0/13', '162.159.0.0/16',
            '173.245.48.0/20', '103.21.244.0/22', '103.22.200.0/22',
            '103.31.4.0/22', '141.101.64.0/18', '108.162.192.0/18',
            '190.93.240.0/20', '188.114.96.0/20', '197.234.240.0/22',
            '198.41.128.0/17', '131.0.72.0/22'
        ]

    @staticmethod
    def get_cloudflare_github():
        try:
            r = _robust_get(
                'https://raw.githubusercontent.com/cloudflare/cloudflare-docs/production/data/ip-ranges.json'
            )
            data = r.json()
            return data.get('ipv4_cidrs', [])
        except Exception as e:
            logger.error("Cloudflare GitHub fetch failed: %s", e)
            return []

    @staticmethod
    def get_fastly_official():
        try:
            r = _robust_get('https://api.fastly.com/public-ip-list')
            return r.json().get('addresses', [])
        except Exception as e:
            logger.error("Fastly official fetch failed: %s", e)
            return []

    @staticmethod
    def get_fastly_asn():
        return [
            '151.101.0.0/16', '199.232.0.0/16',
            '103.244.50.0/24', '103.245.222.0/23',
            '103.245.224.0/24', '104.156.80.0/20'
        ]

    @staticmethod
    def get_builtin_ranges():
        """
        رنج‌های CDN built-in — بدون نیاز به اینترنت.
        پوشش گسترده رنج‌های /24 Cloudflare.
        """
        return BuiltinCDNRanges.get_ranges()

    @staticmethod
    def get_all_sources():
        """Fetch from all online sources and deduplicate."""
        all_ranges = []
        all_ranges.extend(RangeFetcher.get_cloudflare_official())
        all_ranges.extend(RangeFetcher.get_cloudflare_asn())
        all_ranges.extend(RangeFetcher.get_cloudflare_github())
        all_ranges.extend(RangeFetcher.get_fastly_official())
        all_ranges.extend(RangeFetcher.get_fastly_asn())
        return list(set(all_ranges))

    @staticmethod
    def get_all_with_builtin():
        """Fetch from all online sources + built-in ranges, deduplicated."""
        all_ranges = RangeFetcher.get_all_sources()
        all_ranges.extend(RangeFetcher.get_builtin_ranges())
        return list(set(all_ranges))

    @staticmethod
    def fetch_by_source(source):
        source_map = {
            'sh_api': RangeFetcher.get_cloudflare_official,
            'sh_asn': RangeFetcher.get_cloudflare_asn,
            'sh_github': RangeFetcher.get_cloudflare_github,
            'fastly_api': RangeFetcher.get_fastly_official,
            'fastly_asn': RangeFetcher.get_fastly_asn,
            'builtin': RangeFetcher.get_builtin_ranges,
            'all': RangeFetcher.get_all_with_builtin,
            # backward compat
            'all_vfarid': RangeFetcher.get_all_with_builtin,
            'vfarid': RangeFetcher.get_builtin_ranges,
        }
        fn = source_map.get(source, RangeFetcher.get_all_with_builtin)
        return fn()
